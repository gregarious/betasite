{% comment %}
Inner template that renders details about a single place.

Corresponding ViewModel: places.viewmodels.PlaceDetail 

Context variables:
    place:      		Place object with extra fields (e.g. url, hours)
    is_favorite:		boolean (optional)
    tag_list:			a TagList RenderableViewModel
    featured_special: 	Offer object (optional)
    directions_link:	Google Maps link (optional)
{% endcomment %}

{% load self_render from viewmodel_tags %}

<header class="single-header">		
	<h2 class="single-title">{{ place.name }}</h2>
	<div class="single-thumb-container">
		<img alt="{{ place.name }}" src="{{ place.image_url }}" height="500" width="500" />
	</div>
	<div class="single-details">
		<ul>
			{% if place.location.address %}
				<li class="address">
				{{ place.location.address }}
				{% if directions_link %}
					<a href="{{directions_link}}">(directions)</a>
				{% endif %}
				</li>
			{% endif %}

			{% if place.hours %}
		 		<li>{{ place.hours }}</li>
		 	{% endif %}

		 	{% if place.phone %}
		  		<li>Phone: {{ place.phone }}</li>
			{% endif %}

			<li>Parking: Street</li>

			{% if place.url %}
				<li><a href="{{ place.url }}">Visit our website</a></li>
			{% endif %}

		</ul>
			{% self_render tag_list %}
	</div>
</header>

<section class="single-content">
	<ul>
		{% if is_favorite %}
			<li><a href="?action=unfav" class="favbutton remove">Remove from Favorites</a></li>
		{% else %}
			<li><a href="?action=fav" class="favbutton add">Add to Favorites</a></li>
		{% endif %}
		<li><a href="#">Report a problem</a></li>
		<li><a href="#">Post to chatter</a></li>
	</ul>

	{% if place.description %}	
	  	<p>{{ place.description|linebreaksbr|truncatewords:50|urlizetrunc:20 }}</p>	  	
	{% endif %}

	{% if featured_special %}
		<div class="single-featured-special">
			{{featured_special.description}}
			<a href="{% url offers-item-detail featured_special.id %}">Grab it!</a>
		</div>
		{% else %}
			<div class="single-featured-special">
				The Raspberry Pi (or RasPi)[4] is a single-board computer developed in the UK by the Raspberry Pi Foundation. The foundation has released two versions, priced at US$25 and $35 (~GB£16 and ~£22). The $35 model was released first on 29 Febuary 2012[5]. The Raspberry Pi is intended to stimulate the ...
				<a class="grabbit">Grabbit!</a>
			</div>
	{% endif %}

</section>

<script type="text/javascript">
	require(['jquery','helpers/place_actions'],function($,place_actions) {
		// handle the add/remove favorite button
		$(".favbutton").click( function(event) {
			var link = $(this);		// save the link element that fired the event

			// depending on the button class, either attempt adding or 
			// removing favorite state of place
			var changingFavorite;
			if (link.hasClass('add')) {
				changingFavorite = place_actions.addFavorite({{place.id}});
				changingFavorite.done( function(msg) {
					link.text('Remove from Favorites')
						.removeClass('add')
						.addClass('remove');
				});
			}
			else if (link.hasClass('remove')) {
				changingFavorite = place_actions.removeFavorite({{place.id}});
				changingFavorite.done( function(msg) {
					link.text('Add to Favorites')
						.removeClass('remove')
						.addClass('add');
				});
			}

			// in case neither add/remove action was taken, skip the rest
			// (would only happen if the DOM class is messed up)
			if(changingFavorite) {
				// TODO: add spinner
				// fail/always actions are the same despite the promise type
				changingFavorite.fail( function(msg) {
					alert('Failure: ' + msg);	// TODO: do something better
				});
				changingFavorite.always( function() {
					// TODO: remove spinner
				});				
			}

			event.preventDefault();
		});
	});
</script>
