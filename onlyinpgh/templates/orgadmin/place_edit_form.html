<h2>Edting your place...</h2>

<form method="post" action="">

{% csrf_token %}

    <div class="field-container inner">
        <div class="field-label">
            {{ form.name.label_tag }}
        </div>
        <div class="field">
            {{ form.name }}
            {% for err in form.name.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    <div class="field-container inner">
        <div class="field-label">
            {{ form.location.label_tag }}
        </div>
        <div class="field">
            {{ form.location }}
            {% for err in form.location.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    <div class="field-container first">
        <div class="field-label">
            {{ form.phone.label_tag }}
        </div>
        <div class="field">
            {{ form.phone }}
            {% for err in form.phone.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    {# Print out all 7 day-hours fields. Hacky, but works for now #}
    {% include "orgadmin/hours_fieldset.html" with field_days=form.hr_days_1 field_hours=form.hr_hours_1 number=1 omit_plus=form.hr_hours_2.value%}
    {% include "orgadmin/hours_fieldset.html" with field_days=form.hr_days_2 field_hours=form.hr_hours_2 number=2 omit_plus=form.hr_hours_3.value%}
    {% include "orgadmin/hours_fieldset.html" with field_days=form.hr_days_3 field_hours=form.hr_hours_3 number=3 omit_plus=form.hr_hours_4.value%}
    {% include "orgadmin/hours_fieldset.html" with field_days=form.hr_days_4 field_hours=form.hr_hours_4 number=4 omit_plus=form.hr_hours_5.value%}
    {% include "orgadmin/hours_fieldset.html" with field_days=form.hr_days_5 field_hours=form.hr_hours_5 number=5 omit_plus=form.hr_hours_6.value%}
    {% include "orgadmin/hours_fieldset.html" with field_days=form.hr_days_6 field_hours=form.hr_hours_6 number=6 omit_plus=form.hr_hours_7.value%}
    {% include "orgadmin/hours_fieldset.html" with field_days=form.hr_days_7 field_hours=form.hr_hours_7 number=7 omit_plus=1 %}

    <div class="field-container inner">
        <div class="field-label">
            {{ form.parking.label_tag }}
        </div>
        <div class="field">
            {{ form.parking }}
            {% for err in form.parking.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    <div class="field-container first">
        <div class="field-label">
            {{ form.url.label_tag }}
        </div>
        <div class="field">
            {{ form.url }}
            {% for err in form.url.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    <div class="field-container inner">
        <div class="field-label">
            {{ form.image_url.label_tag }}
        </div>
        <div class="field">
            {{ form.image_url }}
            {% for err in form.image_url.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    <div class="field-container first">
        <div class="field-label">
            {{ form.description.label_tag }}
        </div>
        <div class="field">
            {{ form.description }}
            {% for err in form.description.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    <div class="field-container first">
        <div class="field-label">
            {{ form.tags.label_tag }}
        </div>
        <div class="field">
            {{ form.tags }}
            {% for err in form.tags.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    <div class="field-container inner">
        <div class="field-label">
            {{ form.fb_id.label_tag }}
        </div>
        <div class="field">
            <div class="social-input">
                {{ form.fb_id }}
                <img src="/static/img/facebook.png" alt="Facebook icon" />
                {% for err in form.fb_id.errors %}
                    <p class="tip error">{{ err }}</p><br />
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="field-container inner">
        <div class="field-label">
            {{ form.twitter_username.label_tag }}
        </div>
        <div class="field">
            <div class="social-input">
                {{ form.twitter_username }}
                <img src="/static/img/twitter.png" alt="Facebook icon" />
                {% for err in form.twitter_username.errors %}
                    <p class="tip error">{{ err }}</p><br />
                {% endfor %}
            </div>
        </div>
    </div>

    <input type="submit" value="Save Changes" class="submit-item" />
    <a href="{% url onlyinpgh.orgadmin.views.page_list_places %}" class="back" title="Back to places">&larr; Back</a>
</form>

<script type="text/javascript">
// Prerequesites: jQuery, jQuery UI autocomplete
$(function() {
    $(".hour-day-container").on('click', '.add-hour-row-btn', function(event){
        $(this).hide()                  // hides the + button
               .parent().next().show(); // shows the next input
        return false;
    });

    /*** TAG AUTO COMPLETE ***/
    var tagNames = [
        {% for name in tag_names %}
            "{{name|escapejs}}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    function split( val ) {
        return val.split( /,\s*/ );
    }
    function extractLast( term ) {
        return split( term ).pop();
    }

    $('#id_{{form.tags.name}}')
        .on( "keydown", function( event ) {
            if(event.keyCode === $.ui.keyCode.TAB && 
                $(this).data("autocomplete").menu.active ) {
                    event.preventDefault();
                }
        })
        .focus( function( event ) {
            var curVal = $(this).val().replace(/\s+$/,'');
            if(curVal.length > 0 && curVal[curVal.length-1] !== ',') {
                $(this).val(curVal+', ');
            }
        })
        .autocomplete({
            minLength: 1,
            delay: 0,
            autoFocus: true,
            html: true,
            source: function( request, response ) {
                var term = extractLast( request.term );
                if(term.replace(/\s/g,'').length === 0) {
                    response([]);
                    return false;
                }
                var re = $.ui.autocomplete.escapeRegex(term);
                var matcher = new RegExp( "^" + re, "i" );
                var matches = $.grep( tagNames, function(item,index){
                    return matcher.test(item);
                }).slice(0,4);
                response( $.map( matches, function(item) {
                    return {
                        value: item,
                        label: item.replace(matcher, '<b>'+term+'</b>')
                    }
                }) );
            },
            focus: function() {
                // prevent value inserted on focus
                return false;
            },
            select: function( event, ui ) {
                var terms = split( this.value );
                // remove the current input
                terms.pop();
                // add the selected item
                terms.push( ui.item.value );
                // add placeholder to get the comma-and-space at the end
                terms.push( "" );
                this.value = terms.join( ", " );
                return false;
            }
        });
});
</script>