<h2>Add a place...</h2>

<form method="POST" action="{% url orgadmin-claimplace %}">
    {% csrf_token %}
    <div class="field-container inner">
        {{ form.place.errors }}
        <div class="field-label">
            {{ form.place.label_tag }}
        </div>
        <div class="field">
            <input id="id_place-text">
            <input type="hidden" name="{{ form.place.html_name }}" id="id_place">            
            {% for err in form.place.errors %}
                <p class="tip error">{{ err }}</p><br />
            {% endfor %}
        </div>
    </div>

    <div id="confirm-box" style="display:none">
        <p>Great! We've already got your place on record. If this is correct, choose Claim. Otherwise click the "X" and choose again.</p>
        <div id="confirm-content" class="item"></div>
        <div class="item-actions">
          <a id="place-clear" href="#"><img src="{{STATIC_URL}}img/icon_x.gif" /></a>
        </div>
        <button type="submit" disabled="disabled" class="submit-item">Claim</button>
    </div>
</form>

<script type="text/javascript">
$(function(){
    var place_ac_text = $('#id_place-text'),
        place_ac_value = $('#id_place'),
        place_ac_clear_btn = $('#place-clear'),
        place_ac_spinner = $('.spinner'),
        place_ac_confirmbox = $('#confirm-box'),
        place_ac_confirmcontent = $('#confirm-content');

    place_ac_spinner.hide();
    place_ac_clear_btn.hide()
        .on('click', function(event){
            on_ac_deselect();
            $(this).parent().find('#id_place-text').focus();
            return false
        });       

    function on_ac_select(ui) {
        place_ac_text.val(ui.item.selectedLabel);
        place_ac_value.val(ui.item.value);
        place_ac_clear_btn.show();
        $("form :submit").removeAttr('disabled');
        $(".field-container").fadeOut(200);
        $.ajax({
            url: "/orgadmin/ajax/place_confirm/",
            dataType: 'html',
            data: {
                'pid': ui.item.value
            },
            timeout: 3000,
            success: function(html_response) {
                place_ac_confirmcontent.html(html_response);
            },
            error: function(jqXHR, textStatus, errorThrown) {   
                place_ac_confirmcontent.html(ui.item.selectedLabel);
            },
            complete: function(jqXHR, textStatus) {
                place_ac_confirmbox.delay(200).fadeIn(200);
                $('form').css('margin-top', '0');
            }
        });
    }

    function on_ac_deselect(ui) {
        place_ac_text.val('');
        place_ac_value.val('');
        remove_confirmation();
    }

    function remove_confirmation() {
        place_ac_confirmbox.fadeOut(200);
        place_ac_clear_btn.hide();
        $("form :submit").attr('disabled',true);
        $("form").css('margin-top', '2em');
        $(".field-container").delay(200).fadeIn(200);
    }

    place_ac_text.autocomplete({
        html: true,
        autoFocus: true,
        minLength: 2,
        
        source: function(request, response) {
            $.ajax({
                url: "/orgadmin/ajax/placeclaim_ac/",
                dataType: 'json',
                data: {
                    'term': request.term
                },
                timeout: 3000,
                success: function(data) {
                    responses = $.map(data, function(item) {
                        return { 
                            label: '<div class="item-thumb">' +
                                        '<img src=' + item.image_url + ' alt="' + item.name + '" />' +
                                    '</div>' + 
                                    '<div class="item-content">' +
                                        '<h4 class="item-title">'+ item.name + '</h4>' +
                                        '<p class="address">' + item.address + '</p>' +
                                    '</div>',
                            value: item.id,
                            selectedLabel: item.name
                        };
                    });
                    responses.push({
                        label: '<p>Is your place not listed? Create it here.<p>',
                        value:'!newplace'
                    });
                    response(responses);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // TODO: what to do here?
                    console.log('failed!');
                },
                complete: function(jqXHR, textStatus) {
                    place_ac_spinner.hide();
                }
            });
        },
        
        search: function(event, ui) {
            remove_confirmation();
            place_ac_spinner.show();
        },

        select: function(event, ui) {
            if(ui.item.value === '!newplace') {
                window.location.href = "{% url orgadmin-addplace %}";
            }
            else {
                on_ac_select(ui);   // function will show the confirmation dialog
            }
            return false;
        },

        focus: function(event, ui) {
            return false;   // makes it so text doesn't show up in form till selection
        },

        change: function(event, ui) {
            // if something was changed in the text field after a select, the selectedItem will be 
            // cleared out. If no selected item, the inputs get reset.
            var item = $(this).data().autocomplete.selectedItem;
            console.log('change');
            if(!item) {
                on_ac_deselect();
            }
        },
    });
});
</script>