{% comment %}
Inner template that renders details about a single place.

Corresponding ViewModel: places.viewmodels.PlaceDetail 

Context variables:
    place:      		Place object with extra fields (e.g. url, hours)
    	-- Note that place.location will have an optional directions_link field
    is_favorite:		boolean (optional)
    featured_special: 	Offer object (optional)
{% endcomment %}

<h2 class="single-title">{{ place.name }}</h2>

<div class="item-thumb">
	<img alt="{{ place.name }}" src="{{ place.image_url }}" />
	<ul class="utility-nav">
		{% if is_favorite %}
			<li><a href="?action=unfav" class="favbutton remove" title="Remove Favorite"></a></li>
		{% else %}
			<li><a href="?action=fav" class="favbutton add" title="Add Favorite"></a></li>
		{% endif %}
		<li><a href="#" class="report" title="Report a problem"></a></li>
		<li><a href="#" class="post-to-chatter" title="Post to Chatter"></a></li>
	</ul>
</div>

<div class="item-content">

	<ul class="item-details">
		{% if place.location.address %}
			<li class="address">
			{{ place.location.address }}
			{% if place.location.directions_link %}
				<a href="{{place.location.directions_link}}">(directions)</a>
			{% endif %}
			</li>
		{% endif %}

		{% if place.hours %}
	 		<li>{{ place.hours }}</li>
	 	{% endif %}

	 	{% if place.phone %}
	  		<li>Phone: {{ place.phone }}</li>
		{% endif %}

		<li>Parking: Street</li>

		{% if place.url %}
			<li><a href="{{ place.url }}">Visit our website</a></li>
		{% endif %}

	</ul>

	{% include "tags/tag_list.html" with tags=place.tags %}

</div>

<script type="text/javascript">
	require(['jquery','helpers/place_actions'],function($,place_actions) {
		// handle the add/remove favorite button
		$(".favbutton").click( function(event) {
			var link = $(this);		// save the link element that fired the event
			$('.favbutton').html('<p class="changing-fav-spinner">spinner</p>');
			// depending on the button class, either attempt adding or 
			// removing favorite state of place
			var changingFavorite;
			if (link.hasClass('add')) {
				changingFavorite = place_actions.addFavorite({{place.id}});
				changingFavorite.done( function(msg) {
					link.removeClass('add')
						.addClass('remove');
				});
			}
			else if (link.hasClass('remove')) {
				changingFavorite = place_actions.removeFavorite({{place.id}});
				changingFavorite.done( function(msg) {
					link.removeClass('remove')
						.addClass('add');
						// alert('Oops! ' + msg);	// TODO: do something better
				});
			}

			// in case neither add/remove action was taken, skip the rest
			// (would only happen if the DOM class is messed up)
			if(changingFavorite) {
				// TODO: add spinner
				// fail/always actions are the same despite the promise type
				changingFavorite.fail( function(msg) {
					$('.single-thumb-container').append('<div id="favoriteError" class="error">Oops! ' + msg + '</div>'); // Will want to customize the 'not authenticated' msg to include link to login/signup

					// Maybe this isn't needed - without, error duplicated everytime favorited 
					$('#favoriteError').delay(2000).fadeOut(300);	// TODO: do something better
				});
				changingFavorite.always( function() {
					$('.changing-fav-spinner').fadeOut(100);
				});				
			}

			event.preventDefault();
		});
	});
</script>
